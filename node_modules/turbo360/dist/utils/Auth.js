var Promise=require("bluebird"),superagent=require("superagent"),IndexDB=require("./IndexDB"),Auth=function(e){var r=e;return{login:function(e){return new Promise(function(n,o){return null==r.site_id?void o(new Error("Please Set Your TURBO_APP_ID")):r.site_id.length<20?void o(new Error("Please Set Your TURBO_APP_ID")):null==e?void o(new Error("Post parameters required.")):(e.site=r.site_id,void superagent.post(r.base_url+"/auth/login").send(e).set("Accept","application/json").end(function(e,t){if(e)return void o(e);console.log("LOGIN: "+JSON.stringify(t));var i=t.body;if("success"!=i.confirmation){var u=i.message||"Login Failed";return void o(new Error(u))}IndexDB(r).dbTransaction(function(e,u){if(e)return void o(e);u.put({id:r.site_id,token:i.token});var s=t.body.user||t.body.result;n(s)})}))})},logout:function(){return new Promise(function(e,n){return null==r.site_id?void n(new Error("Please Set Your TURBO_APP_ID")):r.site_id.length<20?void n(new Error("Please Set Your TURBO_APP_ID")):void IndexDB(r).dbTransaction(function(o,t){if(o)return void n(o);var i=t.delete(r.site_id);i.onsuccess=function(){console.log("Token Removed"),e(null)},i.onerror=function(e){n(e.target)}})})},currentUser:function(){return new Promise(function(e,n){IndexDB(r).dbTransaction(function(o,t){if(o)return void n(o);var i=t.get(r.site_id);i.onsuccess=function(){if(null==i.result)return void n(new Error("Not Logged In"));superagent.get(r.base_url+"/auth/currentuser").query(null).set("Accept","application/json").set("turbo-token",i.result.token).end(function(r,o){if(r)return void n(r);if("success"!=o.body.confirmation)return void n(new Error(o.body.message));var t=o.body.user||o.body.result;e(t)})},i.onerror=function(e){n(e.target)}})})},createUser:function(e){return new Promise(function(n,o){return null==r.site_id?void o(new Error("Please Set Your TURBO_APP_ID")):r.site_id.length<20?void o(new Error("Please Set Your TURBO_APP_ID")):null==e?void o(new Error("Post parameters required.")):(e.site=r.site_id,void superagent.post(r.base_url+"/auth/createuser").send(e).set("Accept","application/json").end(function(e,t){if(e)return void o(e);var i=t.body;if("success"!=i.confirmation){var u=i.message||"Registration Failed";return void o(new Error(u))}IndexDB(r).dbTransaction(function(e,u){if(e)return void o(e);u.put({id:r.site_id,token:i.token});var s=t.body.user||t.body.result;n(s)})}))})}}};module.exports=Auth;